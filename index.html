<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kotogram Web</title>
    <style>
        /* --- TELEGRAM STYLE CSS --- */
        :root {
            --tg-blue: #3390ec;
            --tg-bg: #e4e4e4; /* –û–±—â–∏–π —Ñ–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            --tg-chat-bg: #9ac1d9; /* –§–æ–Ω —á–∞—Ç–∞ (–∑–∞–≥–ª—É—à–∫–∞ –ø–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫—É) */
            --tg-my-msg: #effdde;
            --tg-other-msg: #ffffff;
            --tg-text: #000;
            --tg-date: #8899a6;
            --tg-border: #dfe1e5;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--tg-bg); 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        .app-container {
            width: 100%;
            height: 100%;
            max-width: 1400px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –¥–ª—è –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
            background: #fff;
            display: flex;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        @media (min-width: 1000px) {
            .app-container { height: 95vh; } /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
        }

        /* --- –≠–ö–†–ê–ù–´ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò (–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ) --- */
        .auth-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--tg-bg);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
        }
        .auth-screen.active { display: flex; }
        
        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 300px;
            text-align: center;
        }
        .auth-box h2 { margin-top: 0; color: var(--tg-text); }
        .auth-box input {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 1px solid var(--tg-border); border-radius: 8px;
            box-sizing: border-box; outline: none;
        }
        .auth-box input:focus { border-color: var(--tg-blue); }
        .tg-btn {
            width: 100%; padding: 12px; margin-top: 10px;
            background: var(--tg-blue); color: white;
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
            text-transform: uppercase; font-size: 14px;
        }
        .tg-btn:hover { opacity: 0.9; }
        .tg-link { color: var(--tg-blue); cursor: pointer; margin-top: 15px; display: block; font-size: 14px; }

        /* --- –ì–õ–ê–í–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° --- */
        #main-interface {
            display: none; width: 100%; height: 100%;
        }
        #main-interface.active { display: flex; }

        /* –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê (–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤) */
        .sidebar {
            width: 350px;
            border-right: 1px solid var(--tg-border);
            display: flex; flex-direction: column;
            background: white;
            position: relative;
        }
        .sidebar-header {
            padding: 10px 15px;
            background: white;
            display: flex; align-items: center; gap: 10px;
        }
        .menu-btn { cursor: pointer; font-size: 20px; color: #707579; }
        .search-bar {
            background: #f1f1f1; border-radius: 20px; padding: 8px 15px;
            flex-grow: 1; border: none; outline: none; color: #000;
        }

        .chat-list {
            flex-grow: 1; overflow-y: auto;
        }
        .chat-item {
            padding: 10px 15px;
            display: flex; align-items: center; gap: 10px;
            cursor: pointer;
            border-bottom: 1px solid transparent;
        }
        .chat-item:hover { background: #f4f4f5; }
        .chat-item.active { background: #3390ec; color: white; }
        .avatar {
            width: 48px; height: 48px; border-radius: 50%;
            background: linear-gradient(135deg, #ffafbd, #ffc3a0);
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; color: white; font-size: 18px;
            flex-shrink: 0;
        }
        .chat-info h4 { margin: 0; font-size: 16px; font-weight: 500; }
        .chat-info p { margin: 3px 0 0; font-size: 14px; color: #707579; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px; }
        .chat-item.active .chat-info p { color: #e1f5fe; }

        /* –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å —á–∞—Ç" (Floating Button) */
        .fab-add {
            position: absolute; bottom: 20px; right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--tg-blue); color: white;
            border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            font-size: 24px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .fab-add:hover { transform: scale(1.05); }

        /* –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê (–û–∫–Ω–æ —á–∞—Ç–∞) */
        .chat-area {
            flex: 1;
            display: flex; flex-direction: column;
            background-color: var(--tg-chat-bg);
            /* –ü–∞—Ç—Ç–µ—Ä–Ω –∫–∞–∫ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2387a6bd' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
            position: relative;
        }

        .chat-header {
            padding: 10px 20px; background: white;
            border-bottom: 1px solid var(--tg-border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-info h3 { margin: 0; font-size: 16px; }
        .header-info span { font-size: 13px; color: #888; }
        
        .messages-container {
            flex-grow: 1; padding: 20px;
            overflow-y: auto; display: flex; flex-direction: column; gap: 8px;
        }
        
        .message {
            max-width: 60%;
            padding: 8px 12px;
            border-radius: 12px;
            position: relative;
            font-size: 15px;
            line-height: 1.4;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .message.my {
            align-self: flex-end;
            background: var(--tg-my-msg);
            border-bottom-right-radius: 2px;
        }
        .message.other {
            align-self: flex-start;
            background: var(--tg-other-msg);
            border-bottom-left-radius: 2px;
        }
        .msg-time {
            float: right; margin-left: 10px; margin-top: 6px;
            font-size: 11px; color: var(--tg-date);
        }
        .message.my .msg-time { color: #5db06d; } /* –ó–µ–ª–µ–Ω–∞—è –≥–∞–ª–æ—á–∫–∞ –∏–º–∏—Ç–∞—Ü–∏—è —Ü–≤–µ—Ç–∞ */

        .input-panel {
            background: white; padding: 10px 20px;
            display: flex; gap: 10px; align-items: center;
        }
        .input-panel input {
            flex-grow: 1; padding: 12px; border: none;
            background: #f4f4f5; border-radius: 20px; outline: none; font-size: 15px;
        }
        .btn-send {
            background: none; border: none; cursor: pointer; color: var(--tg-blue);
            font-weight: bold; font-size: 16px; padding: 0 10px;
        }

        /* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û "–î–û–ë–ê–í–ò–¢–¨ –ß–ê–¢" --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 200;
            display: none; justify-content: center; align-items: center;
        }
        .modal {
            background: white; width: 320px; padding: 20px;
            border-radius: 12px; position: relative;
        }
        .close-modal {
            position: absolute; top: 10px; right: 15px;
            cursor: pointer; font-size: 20px; color: #888;
        }
    </style>
</head>
<body>

<div class="app-container">

    <div id="login-screen" class="auth-screen active">
        <div class="auth-box">
            <div style="width: 80px; height: 80px; background: #3390ec; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="white"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" /></svg>
            </div>
            <h2>–í—Ö–æ–¥ –≤ Kotogram</h2>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="btn-login" class="tg-btn">–í–æ–π—Ç–∏</button>
            <div id="to-register" class="tg-link">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</div>
        </div>
    </div>

    <div id="register-screen" class="auth-screen">
        <div class="auth-box">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="text" id="reg-name" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è">
            <input type="date" id="reg-dob" title="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è">
            <input type="email" id="reg-email" placeholder="Email">
            <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="btn-register" class="tg-btn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <div id="to-login" class="tg-link">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É</div>
        </div>
    </div>

    <div id="main-interface">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <div style="font-weight: bold; font-size: 18px;">Kotogram</div>
                <input type="text" class="search-bar" placeholder="–ü–æ–∏—Å–∫...">
                <div id="btn-logout" class="menu-btn" title="–í—ã–π—Ç–∏">üö™</div>
            </div>

            <div class="chat-list" id="chat-list-container">
                <div style="padding: 20px; text-align: center; color: #888; font-size: 14px;" id="empty-list-placeholder">
                    –ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.<br>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä–∞–Ω–¥–∞—à, —á—Ç–æ–±—ã –Ω–∞–ø–∏—Å–∞—Ç—å.
                </div>
            </div>

            <button class="fab-add" id="btn-add-chat-fab">
                ‚úèÔ∏è
            </button>
        </aside>

        <main class="chat-area">
            <div class="chat-header" id="chat-header" style="visibility: hidden;">
                <div class="header-info">
                    <h3 id="chat-user-name">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                    <span id="chat-user-status">–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ</span>
                </div>
                <div>‚ãÆ</div>
            </div>

            <div class="messages-container" id="messages-list">
                <div style="margin: auto; background: rgba(0,0,0,0.3); color: white; padding: 5px 10px; border-radius: 10px;">
                    –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ
                </div>
            </div>

            <div class="input-panel" id="input-panel" style="visibility: hidden;">
                <span style="font-size: 24px; color: #888; cursor: pointer;">üìé</span>
                <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button id="btn-send" class="btn-send">‚û§</button>
            </div>
        </main>
    </div>

</div>

<div class="modal-overlay" id="search-modal">
    <div class="modal">
        <span class="close-modal" id="close-modal">√ó</span>
        <h3>–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
        <p style="color: #666; font-size: 14px;">–í–≤–µ–¥–∏—Ç–µ Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–º—É —Ö–æ—Ç–∏—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å:</p>
        <input type="email" id="search-email-input" placeholder="user@example.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
        <div id="search-status" style="margin: 10px 0; font-size: 13px;"></div>
        <button id="btn-start-chat" class="tg-btn" style="margin-top: 10px;">–ù–∞–π—Ç–∏ –∏ –Ω–∞–ø–∏—Å–∞—Ç—å</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBKp-HUZXSGSfBfEhl-HIjaC3Yflpqxg7s",
        authDomain: "kotogram-9b0b9.firebaseapp.com",
        databaseURL: "https://kotogram-9b0b9-default-rtdb.firebaseio.com",
        projectId: "kotogram-9b0b9",
        storageBucket: "kotogram-9b0b9.firebasestorage.app",
        messagingSenderId: "755607509917",
        appId: "1:755607509917:web:29b1b85eea516bde702d74"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let currentChatId = null; 
    let activeChatPartner = null; // –û–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞

    // UI —Å—Å—ã–ª–∫–∏
    const screens = {
        login: document.getElementById('login-screen'),
        register: document.getElementById('register-screen'),
        main: document.getElementById('main-interface')
    };
    const modal = document.getElementById('search-modal');

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
    document.getElementById('to-register').onclick = () => { screens.login.classList.remove('active'); screens.register.classList.add('active'); };
    document.getElementById('to-login').onclick = () => { screens.register.classList.remove('active'); screens.login.classList.add('active'); };
    document.getElementById('btn-add-chat-fab').onclick = () => { modal.style.display = 'flex'; document.getElementById('search-status').innerText = ''; };
    document.getElementById('close-modal').onclick = () => modal.style.display = 'none';

    // AUTH
    document.getElementById('btn-register').onclick = async () => {
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-password').value;
        const name = document.getElementById('reg-name').value;
        const dob = document.getElementById('reg-dob').value;
        if(!email || !pass || !name) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");
        try {
            const cred = await createUserWithEmailAndPassword(auth, email, pass);
            await set(ref(db, 'users/' + cred.user.uid), { username: name, email, dob, uid: cred.user.uid });
        } catch(e) { alert(e.message); }
    };

    document.getElementById('btn-login').onclick = async () => {
        try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); }
        catch(e) { alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message); }
    };
    document.getElementById('btn-logout').onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            screens.login.classList.remove('active');
            screens.register.classList.remove('active');
            screens.main.classList.add('active');
        } else {
            currentUser = null;
            screens.main.classList.remove('active');
            screens.login.classList.add('active');
            document.getElementById('chat-list-container').innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
        }
    });

    // –ü–û–ò–°–ö –ò –°–û–ó–î–ê–ù–ò–ï –ß–ê–¢–ê
    document.getElementById('btn-start-chat').onclick = async () => {
        const email = document.getElementById('search-email-input').value;
        const statusDiv = document.getElementById('search-status');
        
        if(email === currentUser.email) {
            statusDiv.innerText = "–ù–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ"; return;
        }

        statusDiv.innerText = "–ü–æ–∏—Å–∫...";
        const q = query(ref(db, 'users'), orderByChild('email'), equalTo(email));
        
        try {
            const snap = await get(q);
            if(snap.exists()) {
                const data = snap.val();
                const uid = Object.keys(data)[0];
                const userInfo = data[uid];
                
                addChatToSidebar(userInfo); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–µ–≤—É—é –∫–æ–ª–æ–Ω–∫—É
                openChat(userInfo); // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç —Å–ø—Ä–∞–≤–∞
                
                modal.style.display = 'none';
                document.getElementById('search-email-input').value = '';
            } else {
                statusDiv.innerText = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω";
                statusDiv.style.color = "red";
            }
        } catch(e) { console.error(e); }
    };

    // –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê
    function addChatToSidebar(userInfo) {
        document.getElementById('empty-list-placeholder').style.display = 'none';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ (–≤–∏–∑—É–∞–ª—å–Ω–æ)
        const existingId = `chat-item-${userInfo.uid}`;
        if(document.getElementById(existingId)) return; 

        const div = document.createElement('div');
        div.className = 'chat-item';
        div.id = existingId;
        div.onclick = () => openChat(userInfo);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã
        const initials = userInfo.username.substring(0,2).toUpperCase();

        div.innerHTML = `
            <div class="avatar">${initials}</div>
            <div class="chat-info">
                <h4>${userInfo.username}</h4>
                <p>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</p>
            </div>
        `;
        document.getElementById('chat-list-container').prepend(div);
    }

    function openChat(userInfo) {
        activeChatPartner = userInfo;
        
        // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ –º–µ–Ω—é
        document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
        const item = document.getElementById(`chat-item-${userInfo.uid}`);
        if(item) item.classList.add('active');

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        document.getElementById('chat-header').style.visibility = 'visible';
        document.getElementById('input-panel').style.visibility = 'visible';
        document.getElementById('chat-user-name').innerText = userInfo.username;
        document.getElementById('chat-user-status').innerText = userInfo.email; // –ü–æ–∫–∞–∂–µ–º email –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ç—É—Å–∞

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID —á–∞—Ç–∞
        const ids = [currentUser.uid, userInfo.uid].sort();
        currentChatId = ids[0] + "_" + ids[1];

        listenForMessages();
    }

    function listenForMessages() {
        const list = document.getElementById('messages-list');
        list.innerHTML = '';
        
        onValue(ref(db, 'messages/' + currentChatId), (snap) => {
            list.innerHTML = '';
            const data = snap.val();
            if(data) {
                Object.values(data).forEach(msg => {
                    const isMy = msg.senderId === currentUser.uid;
                    const el = document.createElement('div');
                    el.className = `message ${isMy ? 'my' : 'other'}`;
                    
                    const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    el.innerHTML = `
                        ${msg.text}
                        <span class="msg-time">${time}</span>
                    `;
                    list.appendChild(el);
                });
                list.scrollTop = list.scrollHeight;
            }
        });
    }

    // –û–¢–ü–†–ê–í–ö–ê
    document.getElementById('btn-send').onclick = sendMessage;
    document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

    function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if(!text || !currentChatId) return;

        push(ref(db, 'messages/' + currentChatId), {
            senderId: currentUser.uid,
            text: text,
            timestamp: Date.now()
        });
        input.value = '';
    }
</script>

</body>
</html>
