<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kotogram Ultimate</title>
    <style>
        /* --- VARIABLES & THEMES --- */
        :root {
            --tg-blue: #3390ec;
            --tg-bg: #f1f1f1;
            --tg-sidebar-bg: #ffffff;
            --tg-text: #000;
            --tg-secondary: #707579;
            --tg-border: #dfe1e5;
            --tg-my-msg: #eeffde;
            --tg-other-msg: #ffffff;
            --tg-hover: #f4f4f5;
            --tg-shadow: rgba(0,0,0,0.1);
        }

        body.dark-mode {
            --tg-bg: #0f0f0f;
            --tg-sidebar-bg: #212121;
            --tg-text: #ffffff;
            --tg-secondary: #aaaaaa;
            --tg-border: #2f2f2f;
            --tg-my-msg: #764ba2; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
            --tg-other-msg: #212121;
            --tg-hover: #2c2c2c;
            --tg-shadow: rgba(0,0,0,0.5);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif; 
            background: var(--tg-bg); margin: 0; height: 100vh; 
            display: flex; justify-content: center; align-items: center; overflow: hidden;
            transition: background 0.3s;
        }

        /* --- LAYOUT --- */
        .app-window {
            width: 100%; height: 100%; max-width: 1600px;
            background: var(--tg-sidebar-bg); display: flex; 
            box-shadow: 0 0 20px var(--tg-shadow);
            position: relative; overflow: hidden;
        }
        @media (min-width: 1000px) { .app-window { height: 95vh; border-radius: 8px; } }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 380px; border-right: 1px solid var(--tg-border);
            display: flex; flex-direction: column; background: var(--tg-sidebar-bg);
            z-index: 10; transition: transform 0.3s;
        }
        .sidebar-header { padding: 15px; display: flex; align-items: center; gap: 10px; }
        .icon-btn { 
            font-size: 20px; cursor: pointer; color: var(--tg-secondary); 
            padding: 8px; border-radius: 50%; transition: 0.2s; background: transparent; border: none;
        }
        .icon-btn:hover { background: var(--tg-hover); color: var(--tg-blue); }

        .search-box {
            flex-grow: 1; position: relative;
        }
        .search-input {
            width: 100%; background: var(--tg-hover); border: 1px solid transparent;
            padding: 10px 15px 10px 35px; border-radius: 20px; outline: none;
            color: var(--tg-text); transition: 0.2s; box-sizing: border-box;
        }
        .search-input:focus { background: var(--tg-sidebar-bg); border-color: var(--tg-blue); }

        .chat-list { flex-grow: 1; overflow-y: auto; }
        .chat-item {
            padding: 10px 15px; display: flex; align-items: center; gap: 12px;
            cursor: pointer; position: relative;
        }
        .chat-item:hover { background: var(--tg-hover); }
        .chat-item.active { background: var(--tg-blue); }
        .chat-item.active * { color: white !important; }

        .avatar {
            width: 50px; height: 50px; border-radius: 50%;
            background: #ccc; color: white; display: flex; justify-content: center; align-items: center;
            font-size: 18px; font-weight: bold; flex-shrink: 0; position: relative;
        }
        .online-dot {
            width: 12px; height: 12px; background: #00c73e; border: 2px solid var(--tg-sidebar-bg);
            border-radius: 50%; position: absolute; bottom: 0; right: 0; display: none;
        }

        .chat-info { flex-grow: 1; min-width: 0; }
        .row-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .chat-name { font-weight: 600; font-size: 16px; color: var(--tg-text); }
        .chat-msg { font-size: 14px; color: var(--tg-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* FAB Button */
        .fab {
            position: absolute; bottom: 25px; right: 25px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--tg-blue); color: white;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s ease-in-out; z-index: 100;
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); }
        .fab.hidden { transform: scale(0); pointer-events: none; }

        /* --- CHAT AREA --- */
        .chat-area {
            flex: 1; display: flex; flex-direction: column; position: relative;
            background-color: #212121; /* Fallback */
            background-image: url("https://web.telegram.org/a/chat-bg-pattern-dark.ad38368a9e8140d0.png"); /* Telegram Dark Pattern */
            background-size: 400px;
        }
        body:not(.dark-mode) .chat-area {
            background-color: #9ac1d9;
            background-image: url("https://web.telegram.org/a/chat-bg-pattern-light.ee148af944f65802.png");
        }

        .chat-header {
            background: var(--tg-sidebar-bg); padding: 0 15px; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--tg-border); flex-shrink: 0; z-index: 20;
        }
        .header-info { display: flex; flex-direction: column; cursor: pointer; margin-left: 10px; }
        .header-name { font-weight: 600; font-size: 16px; color: var(--tg-text); }
        .header-status { font-size: 13px; color: var(--tg-secondary); }
        .header-status.typing { color: var(--tg-blue); font-weight: bold; }

        /* Pinned Message Bar */
        .pinned-bar {
            background: var(--tg-sidebar-bg); border-bottom: 1px solid var(--tg-border);
            padding: 5px 15px; display: flex; align-items: center; gap: 10px;
            font-size: 13px; color: var(--tg-blue); cursor: pointer; display: none; z-index: 15;
        }
        .pinned-line { width: 2px; height: 30px; background: var(--tg-blue); }

        .messages-list {
            flex-grow: 1; overflow-y: auto; padding: 10px 5%;
            display: flex; flex-direction: column; gap: 4px;
        }

        /* Date Separator */
        .date-separator {
            align-self: center; background: rgba(0,0,0,0.3); color: white;
            padding: 4px 12px; border-radius: 12px; font-size: 12px; margin: 10px 0;
            backdrop-filter: blur(2px);
        }

        .msg {
            max-width: 400px; padding: 6px 10px; border-radius: 10px;
            position: relative; font-size: 15px; line-height: 1.4;
            box-shadow: 0 1px 2px var(--tg-shadow);
            animation: fadeIn 0.2s ease-out; word-wrap: break-word;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg.my { align-self: flex-end; background: var(--tg-my-msg); color: var(--tg-text); border-bottom-right-radius: 2px; }
        .msg.other { align-self: flex-start; background: var(--tg-other-msg); color: var(--tg-text); border-bottom-left-radius: 2px; }
        
        .msg img { max-width: 100%; border-radius: 8px; cursor: pointer; margin-top: 5px; }

        /* Reply Preview inside Message */
        .msg-reply-preview {
            border-left: 2px solid var(--tg-blue); padding-left: 6px; margin-bottom: 4px;
            font-size: 12px; color: var(--tg-blue); cursor: pointer;
        }

        .msg-meta {
            float: right; margin-left: 8px; margin-top: 6px; display: flex; align-items: center; gap: 3px;
            font-size: 11px; color: var(--tg-secondary); user-select: none;
        }
        .msg.my .msg-meta { color: #5db06d; }

        /* Input Area */
        .input-wrapper { background: var(--tg-sidebar-bg); padding: 5px 10px; border-top: 1px solid var(--tg-border); }
        
        /* Reply Bar above Input */
        .reply-bar {
            display: none; padding: 8px 15px; background: var(--tg-sidebar-bg);
            border-bottom: 1px solid var(--tg-border); align-items: center; justify-content: space-between;
        }
        .reply-content { border-left: 2px solid var(--tg-blue); padding-left: 10px; font-size: 13px; color: var(--tg-text); }

        .input-area { display: flex; align-items: flex-end; gap: 8px; padding-top: 5px; }
        .input-field {
            flex-grow: 1; max-height: 120px; min-height: 20px; padding: 10px;
            border-radius: 18px; background: var(--tg-hover); border: none; outline: none;
            color: var(--tg-text); font-size: 16px; resize: none; overflow-y: auto;
        }
        .action-btn { background: none; border: none; color: var(--tg-secondary); cursor: pointer; font-size: 22px; padding: 5px; }
        .action-btn:hover { color: var(--tg-blue); }
        .send-btn { color: var(--tg-blue); transform: rotate(0deg); transition: 0.2s; }

        /* Emoji Picker */
        .emoji-picker {
            position: absolute; bottom: 70px; left: 10px; background: var(--tg-sidebar-bg);
            border: 1px solid var(--tg-border); border-radius: 10px; padding: 10px;
            display: none; grid-template-columns: repeat(6, 1fr); gap: 5px; width: 250px;
            box-shadow: 0 5px 15px var(--tg-shadow); z-index: 50;
        }
        .emoji { cursor: pointer; font-size: 20px; padding: 5px; text-align: center; border-radius: 5px; }
        .emoji:hover { background: var(--tg-hover); }

        /* Context Menu */
        .ctx-menu {
            position: absolute; background: var(--tg-sidebar-bg); width: 180px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); border-radius: 8px; display: none;
            flex-direction: column; z-index: 200; overflow: hidden;
        }
        .ctx-item { padding: 10px 15px; cursor: pointer; font-size: 14px; color: var(--tg-text); display: flex; gap: 10px; }
        .ctx-item:hover { background: var(--tg-hover); }
        .ctx-item.red { color: #ff595a; }

        /* Fullscreen Image */
        .fullscreen-img {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9);
            display:none; justify-content:center; align-items:center; z-index: 5000;
        }
        .fullscreen-img img { max-width:95%; max-height:95%; }

        /* Mobile */
        @media (max-width: 768px) {
            .app-window { width: 100%; height: 100vh; border-radius: 0; }
            .sidebar { width: 100%; position: absolute; height: 100%; }
            .sidebar.hidden { transform: translateX(-20%); opacity: 0; pointer-events: none; }
            .chat-area { width: 100%; position: absolute; height: 100%; transform: translateX(100%); transition: transform 0.3s; }
            .chat-area.active { transform: translateX(0); }
            .back-btn { display: block !important; }
        }
        .back-btn { display: none; margin-right: 10px; font-size: 24px; color: var(--tg-text); cursor: pointer; }

        /* Modals */
        .modal-wrap {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 2000; display: none;
            justify-content: center; align-items: center;
        }
        .modal-box {
            background: var(--tg-sidebar-bg); width: 320px; padding: 25px; border-radius: 12px;
            text-align: center; position: relative;
        }
        .modal-input {
            width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--tg-border);
            border-radius: 8px; background: var(--tg-bg); color: var(--tg-text); box-sizing: border-box;
        }
        .modal-btn {
            width: 100%; padding: 12px; background: var(--tg-blue); color: white;
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px;
        }
    </style>
</head>
<body>

<audio id="msg-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

<div class="ctx-menu" id="ctx-menu">
    <div class="ctx-item" id="ctx-reply">‚Ü©Ô∏è –û—Ç–≤–µ—Ç–∏—Ç—å</div>
    <div class="ctx-item" id="ctx-copy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
    <div class="ctx-item" id="ctx-pin">üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>
    <div class="ctx-item" id="ctx-edit">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</div>
    <div class="ctx-item red" id="ctx-delete">üóë –£–¥–∞–ª–∏—Ç—å</div>
</div>

<div class="fullscreen-img" id="fs-img-view" onclick="this.style.display='none'">
    <img id="fs-img-tag" src="">
</div>

<div class="app-window" id="app-window">
    
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="icon-btn" id="btn-theme">üåô</button>
            <div class="search-box">
                <input type="text" class="search-input" id="search-chat" placeholder="–ü–æ–∏—Å–∫">
            </div>
            <button class="icon-btn" id="btn-profile">‚öôÔ∏è</button>
        </div>
        <div class="chat-list" id="chat-list"></div>
        <div class="fab" id="fab-new">+</div>
    </aside>

    <main class="chat-area" id="chat-area">
        <div class="chat-header">
            <div style="display:flex; align-items:center;">
                <div class="back-btn" id="btn-back">‚Üê</div>
                <div class="header-info">
                    <div class="header-name" id="chat-title">...</div>
                    <div class="header-status" id="chat-status">...</div>
                </div>
            </div>
            <button class="icon-btn">‚ãÆ</button>
        </div>

        <div class="pinned-bar" id="pinned-bar">
            <div class="pinned-line"></div>
            <div>
                <div style="font-weight:600; font-size:12px;">–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                <div id="pinned-text" style="color:var(--tg-text); opacity:0.8;">–¢–µ–∫—Å—Ç...</div>
            </div>
            <div style="margin-left:auto; font-size:16px;">√ó</div>
        </div>

        <div class="messages-list" id="msg-list">
            <div style="text-align:center; margin-top:50%; color:#888;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</div>
        </div>

        <div class="input-wrapper" id="input-wrapper" style="visibility:hidden;">
            <div class="reply-bar" id="reply-bar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="reply-icon" style="color:var(--tg-blue); font-size:20px;">‚Ü©Ô∏è</span>
                    <div class="reply-content">
                        <div style="color:var(--tg-blue); font-weight:bold;" id="reply-title">–û—Ç–≤–µ—Ç</div>
                        <div id="reply-text">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</div>
                    </div>
                </div>
                <button class="icon-btn" id="btn-cancel-reply">√ó</button>
            </div>

            <div class="input-area">
                <button class="action-btn" id="btn-emoji">üòÉ</button>
                <div class="emoji-picker" id="emoji-picker"></div>
                
                <textarea id="msg-input" class="input-field" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                
                <input type="file" id="file-input" accept="image/*" hidden>
                <button class="action-btn" id="btn-attach" onclick="document.getElementById('file-input').click()">üìé</button>
                <button class="action-btn send-btn" id="btn-send">‚û§</button>
            </div>
        </div>
    </main>
</div>

<div class="modal-wrap" id="modal-auth" style="display:flex;"> <div class="modal-box">
        <div style="font-size:40px; margin-bottom:10px;">üêà</div>
        <h2>Kotogram Ult.</h2>
        <div id="form-login">
            <input type="email" id="l-email" class="modal-input" placeholder="Email">
            <input type="password" id="l-pass" class="modal-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="modal-btn" id="btn-do-login">–í–æ–π—Ç–∏</button>
            <div style="margin-top:10px; color:var(--tg-blue); cursor:pointer;" onclick="switchAuth('reg')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        </div>
        <div id="form-reg" style="display:none;">
            <input type="text" id="r-name" class="modal-input" placeholder="–í–∞—à–µ –ò–º—è">
            <input type="email" id="r-email" class="modal-input" placeholder="Email">
            <input type="password" id="r-pass" class="modal-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="modal-btn" id="btn-do-reg">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <div style="margin-top:10px; color:var(--tg-blue); cursor:pointer;" onclick="switchAuth('login')">–ù–∞–∑–∞–¥</div>
        </div>
    </div>
</div>

<div class="modal-wrap" id="modal-new-chat">
    <div class="modal-box">
        <span style="position:absolute; right:15px; top:10px; cursor:pointer;" onclick="document.getElementById('modal-new-chat').style.display='none'">√ó</span>
        <h3>–ù–æ–≤—ã–π —á–∞—Ç</h3>
        <input type="email" id="new-chat-email" class="modal-input" placeholder="Email —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
        <button class="modal-btn" id="btn-find-chat">–ù–∞—á–∞—Ç—å</button>
    </div>
</div>

<div class="modal-wrap" id="modal-profile">
    <div class="modal-box">
        <span style="position:absolute; right:15px; top:10px; cursor:pointer;" onclick="document.getElementById('modal-profile').style.display='none'">√ó</span>
        <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
        <input type="text" id="edit-name" class="modal-input" placeholder="–ò–º—è">
        <button class="modal-btn" id="btn-save-profile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="modal-btn" id="btn-logout" style="background:#ff595a; margin-top:10px;">–í—ã–π—Ç–∏</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, query, orderByChild, equalTo, get, update, remove, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBKp-HUZXSGSfBfEhl-HIjaC3Yflpqxg7s",
        authDomain: "kotogram-9b0b9.firebaseapp.com",
        databaseURL: "https://kotogram-9b0b9-default-rtdb.firebaseio.com",
        projectId: "kotogram-9b0b9",
        storageBucket: "kotogram-9b0b9.firebasestorage.app",
        messagingSenderId: "755607509917",
        appId: "1:755607509917:web:29b1b85eea516bde702d74"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let user = null;
    let chatId = null;
    let partnerId = null;
    let partnerName = "";
    
    // States
    let replyId = null;
    let replyTextVal = null;
    let editId = null;
    let typingTimer = null;
    let ctxMsg = null; // Message object for context menu

    // UI Refs
    const el = (id) => document.getElementById(id);
    const show = (id) => el(id).style.display = 'flex';
    const hide = (id) => el(id).style.display = 'none';

    // --- AUTH ---
    window.switchAuth = (mode) => {
        el('form-login').style.display = mode === 'login' ? 'block' : 'none';
        el('form-reg').style.display = mode === 'reg' ? 'block' : 'none';
    };

    el('btn-do-reg').onclick = async () => {
        try {
            const cred = await createUserWithEmailAndPassword(auth, el('r-email').value, el('r-pass').value);
            await set(ref(db, 'users/' + cred.user.uid), { username: el('r-name').value, email: el('r-email').value });
        } catch(e) { alert(e.message); }
    };
    el('btn-do-login').onclick = async () => {
        try { await signInWithEmailAndPassword(auth, el('l-email').value, el('l-pass').value); } catch(e) { alert(e.message); }
    };
    el('btn-logout').onclick = () => signOut(auth);

    onAuthStateChanged(auth, (u) => {
        user = u;
        if(u) {
            hide('modal-auth');
            // Presence
            const conRef = ref(db, ".info/connected");
            onValue(conRef, (snap) => {
                if(snap.val()) {
                    onDisconnect(ref(db, `users/${u.uid}/status`)).set(serverTimestamp());
                    set(ref(db, `users/${u.uid}/status`), "online");
                }
            });
            // Load Profile
            get(ref(db, `users/${u.uid}`)).then(s => { if(s.exists()) el('edit-name').value = s.val().username; });
            // Dark Mode
            if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
            loadChats();
        } else {
            show('modal-auth');
            el('chat-list').innerHTML = '';
        }
    });

    // --- CHAT LIST ---
    function loadChats() {
        onValue(ref(db, `user-chats/${user.uid}`), (snap) => {
            const list = el('chat-list');
            list.innerHTML = '';
            const chats = [];
            snap.forEach(c => chats.push(c.val()));
            chats.sort((a,b) => b.lastMsgTime - a.lastMsgTime);
            
            const filter = el('search-chat').value.toLowerCase();

            chats.forEach(c => {
                if(filter && !c.partnerName.toLowerCase().includes(filter)) return;
                
                const div = document.createElement('div');
                div.className = `chat-item ${c.partnerId === partnerId ? 'active' : ''}`;
                div.onclick = () => enterChat(c);
                
                const color = ["#e91e63","#9c27b0","#673ab7","#3f51b5","#009688"][c.partnerName.length % 5];
                const time = new Date(c.lastMsgTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                
                div.innerHTML = `
                    <div class="avatar" style="background:${color}">
                        ${c.partnerName[0].toUpperCase()}
                        <div class="online-dot" id="dot-${c.partnerId}"></div>
                    </div>
                    <div class="chat-info">
                        <div class="row-top">
                            <div class="chat-name">${c.partnerName}</div>
                            <div style="font-size:12px; opacity:0.7;">${time}</div>
                        </div>
                        <div class="chat-msg">
                            ${c.lastMsgSender === user.uid ? '<span style="color:var(--tg-blue)">–í—ã:</span> ' : ''}
                            ${c.lastMsg}
                        </div>
                    </div>
                `;
                list.appendChild(div);
                
                onValue(ref(db, `users/${c.partnerId}/status`), (s) => {
                    if(document.getElementById(`dot-${c.partnerId}`))
                        document.getElementById(`dot-${c.partnerId}`).style.display = s.val() === 'online' ? 'block' : 'none';
                });
            });
        });
    }
    el('search-chat').oninput = loadChats;

    // --- ENTER CHAT ---
    function enterChat(c) {
        partnerId = c.partnerId;
        partnerName = c.partnerName;
        const ids = [user.uid, partnerId].sort();
        chatId = ids[0] + "_" + ids[1];
        
        // UI
        if(window.innerWidth <= 768) {
            el('chat-area').classList.add('active');
            el('sidebar').classList.add('hidden');
        }
        el('fab-new').classList.add('hidden'); // –ö–Ω–æ–ø–∫–∞ –∏—Å—á–µ–∑–∞–µ—Ç
        el('input-wrapper').style.visibility = 'visible';
        el('chat-title').innerText = partnerName;
        loadChats(); // Highlight active
        
        // Status & Typing
        const statusRef = ref(db, `users/${partnerId}/status`);
        onValue(statusRef, s => {
            const val = s.val();
            el('chat-status').innerText = val === 'online' ? '–≤ —Å–µ—Ç–∏' : (val ? '–±—ã–ª(–∞) ' + new Date(val).toLocaleString() : '–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ');
            el('chat-status').classList.remove('typing');
        });
        onValue(ref(db, `typing/${chatId}/${partnerId}`), s => {
            if(s.val()) {
                el('chat-status').innerText = "–ø–µ—á–∞—Ç–∞–µ—Ç...";
                el('chat-status').classList.add('typing');
            } else {
                get(statusRef).then(snap => { /* Revert status */ }); // Simplified
            }
        });

        // Pinned Message
        onValue(ref(db, `pinned/${chatId}`), s => {
            if(s.val()) {
                el('pinned-bar').style.display = 'flex';
                el('pinned-text').innerText = s.val().text;
                el('pinned-bar').onclick = () => scrollToMsg(s.val().id);
            } else {
                el('pinned-bar').style.display = 'none';
            }
        });

        loadMessages();
    }

    // --- MESSAGES ---
    function loadMessages() {
        onValue(ref(db, `messages/${chatId}`), (snap) => {
            const list = el('msg-list');
            list.innerHTML = '';
            const msgs = [];
            snap.forEach(c => msgs.push({key: c.key, ...c.val()}));
            
            if(msgs.length === 0) list.innerHTML = '<div style="text-align:center;margin-top:50%;color:gray;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';

            let lastDate = null;

            msgs.forEach(msg => {
                // Date Separator
                const dateObj = new Date(msg.timestamp);
                const dateStr = dateObj.toLocaleDateString();
                if(dateStr !== lastDate) {
                    const sep = document.createElement('div');
                    sep.className = 'date-separator';
                    sep.innerText = dateStr;
                    list.appendChild(sep);
                    lastDate = dateStr;
                }

                // Sound
                if(!msg.read && msg.senderId !== user.uid) {
                    el('msg-sound').play().catch(()=>{});
                    update(ref(db, `messages/${chatId}/${msg.key}`), {read:true});
                }

                const div = document.createElement('div');
                div.className = `msg ${msg.senderId === user.uid ? 'my' : 'other'}`;
                div.id = `msg-${msg.key}`;
                
                // Context Menu Hook
                div.oncontextmenu = (e) => {
                    e.preventDefault();
                    ctxMsg = msg;
                    const menu = el('ctx-menu');
                    menu.style.display = 'flex';
                    menu.style.left = Math.min(e.pageX, window.innerWidth - 190) + 'px';
                    menu.style.top = e.pageY + 'px';
                };

                // Content
                let content = "";
                // Reply Preview
                if(msg.replyTo) {
                    content += `<div class="msg-reply-preview" onclick="document.getElementById('msg-${msg.replyTo.id}').scrollIntoView({behavior:'smooth', block:'center'})">
                        <div style="font-weight:bold;">${msg.replyTo.name}</div>
                        <div style="opacity:0.8; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${msg.replyTo.text}</div>
                    </div>`;
                }
                
                // Text/Image
                if(msg.type === 'image') {
                    content += `<img src="${msg.text}" onclick="document.getElementById('fs-img-tag').src=this.src; document.getElementById('fs-img-view').style.display='flex'">`;
                } else {
                    // Link highlighting
                    const text = msg.text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:var(--tg-blue); text-decoration:none;">$1</a>');
                    content += text;
                }

                // Edit mark
                if(msg.edited) content += ' <span style="font-size:10px; opacity:0.6">(–∏–∑–º.)</span>';

                const time = dateObj.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                const checks = msg.senderId === user.uid ? (msg.read ? '‚úì‚úì' : '‚úì') : '';

                div.innerHTML = `${content}<div class="msg-meta">${time} <span style="color:${msg.read?'#4fb5d6':''}">${checks}</span></div>`;
                list.appendChild(div);
            });
            list.scrollTop = list.scrollHeight;
        });
    }

    // --- ACTIONS ---
    function scrollToMsg(id) {
        const m = document.getElementById(`msg-${id}`);
        if(m) {
            m.scrollIntoView({behavior:'smooth', block:'center'});
            m.style.background = '#ffd700'; // Flash effect
            setTimeout(() => m.style.background = '', 1000);
        }
    }

    // Sending
    async function sendMessage(text, type='text') {
        if(!chatId) return;
        const ts = Date.now();
        
        if(editId) {
            // Edit Mode
            await update(ref(db, `messages/${chatId}/${editId}`), { text: text, edited: true });
            cancelReply();
            return;
        }

        const msgData = {
            senderId: user.uid,
            text: text,
            timestamp: ts,
            type: type,
            read: false
        };

        if(replyId) {
            msgData.replyTo = { id: replyId, text: replyTextVal, name: partnerName }; // Simplified name logic
        }

        await push(ref(db, `messages/${chatId}`), msgData);

        // Update Chat List
        const lastMsgText = type === 'image' ? 'üì∑ –§–æ—Ç–æ' : text;
        const updateData = { lastMsg: lastMsgText, lastMsgTime: ts, lastMsgSender: user.uid };
        
        update(ref(db, `user-chats/${user.uid}/${partnerId}`), { ...updateData, partnerId, partnerName });
        
        get(ref(db, `users/${user.uid}`)).then(s => {
             update(ref(db, `user-chats/${partnerId}/${user.uid}`), { ...updateData, partnerId: user.uid, partnerName: s.val().username });
        });

        cancelReply();
    }

    // Handlers
    el('btn-send').onclick = () => {
        const txt = el('msg-input').value.trim();
        if(txt) { sendMessage(txt); el('msg-input').value = ''; }
    };
    el('msg-input').onkeydown = (e) => { 
        if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); el('btn-send').click(); }
        // Typing indicator logic
        update(ref(db, `typing/${chatId}/${user.uid}`), true);
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => remove(ref(db, `typing/${chatId}/${user.uid}`)), 2000);
    };

    // File Upload
    el('file-input').onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            sendMessage(evt.target.result, 'image');
        };
        reader.readAsDataURL(file);
    };

    // --- CONTEXT MENU ACTIONS ---
    document.onclick = (e) => { if(!e.target.closest('.ctx-menu')) hide('ctx-menu'); hide('emoji-picker'); };
    
    el('ctx-delete').onclick = () => { if(ctxMsg) remove(ref(db, `messages/${chatId}/${ctxMsg.key}`)); };
    
    el('ctx-copy').onclick = () => { 
        navigator.clipboard.writeText(ctxMsg.text); 
        alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"); 
    };

    el('ctx-pin').onclick = () => {
        set(ref(db, `pinned/${chatId}`), { id: ctxMsg.key, text: ctxMsg.type === 'image' ? '–§–æ—Ç–æ' : ctxMsg.text });
    };

    el('ctx-reply').onclick = () => {
        replyId = ctxMsg.key;
        replyTextVal = ctxMsg.type === 'image' ? '–§–æ—Ç–æ' : ctxMsg.text;
        
        el('reply-bar').style.display = 'flex';
        el('reply-title').innerText = "–û—Ç–≤–µ—Ç";
        el('reply-text').innerText = replyTextVal;
        el('reply-icon').innerText = "‚Ü©Ô∏è";
        el('msg-input').focus();
    };

    el('ctx-edit').onclick = () => {
        if(ctxMsg.senderId !== user.uid) return alert("–ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è");
        if(ctxMsg.type === 'image') return alert("–ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ");
        
        editId = ctxMsg.key;
        el('reply-bar').style.display = 'flex';
        el('reply-title').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
        el('reply-text').innerText = ctxMsg.text;
        el('reply-icon').innerText = "‚úèÔ∏è";
        el('msg-input').value = ctxMsg.text;
        el('msg-input').focus();
    };

    el('btn-cancel-reply').onclick = cancelReply;
    function cancelReply() {
        replyId = null; editId = null; replyTextVal = null;
        el('reply-bar').style.display = 'none';
        el('msg-input').value = '';
    }

    // --- EMOJI ---
    const emojis = ["üòÄ","üòÇ","üòç","üòé","üò≠","üò°","üëç","üëé","‚ù§Ô∏è","üî•","üí©","üéâ","ü§î","üëÄ","ü§°","üëª","ü§ñ","üéÉ"];
    const picker = el('emoji-picker');
    emojis.forEach(e => {
        const s = document.createElement('div');
        s.className = 'emoji'; s.innerText = e;
        s.onclick = () => el('msg-input').value += e;
        picker.appendChild(s);
    });
    el('btn-emoji').onclick = (e) => { e.stopPropagation(); picker.style.display = 'grid'; };

    // --- UI HELPERS ---
    el('btn-theme').onclick = () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    };
    el('fab-new').onclick = () => show('modal-new-chat');
    el('btn-find-chat').onclick = async () => {
        const email = el('new-chat-email').value;
        const q = query(ref(db, 'users'), orderByChild('email'), equalTo(email));
        const s = await get(q);
        if(s.exists()) {
            const uid = Object.keys(s.val())[0];
            hide('modal-new-chat');
            enterChat({partnerId: uid, partnerName: s.val()[uid].username});
        } else alert("–ù–µ –Ω–∞–π–¥–µ–Ω");
    };
    
    el('btn-profile').onclick = () => show('modal-profile');
    el('btn-save-profile').onclick = () => {
        update(ref(db, `users/${user.uid}`), { username: el('edit-name').value });
        hide('modal-profile');
    };
    
    // Mobile Back
    el('btn-back').onclick = () => {
        el('chat-area').classList.remove('active');
        el('sidebar').classList.remove('hidden');
        el('fab-new').classList.remove('hidden');
        chatId = null;
    };
</script>

</body>
</html>
