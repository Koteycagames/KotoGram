<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kotogram Pro</title>
    <style>
        /* --- TELEGRAM STYLE CSS --- */
        :root {
            --tg-blue: #3390ec;
            --tg-bg: #e4e4e4;
            --tg-chat-bg: #9ac1d9;
            --tg-my-msg: #effdde;
            --tg-white: #ffffff;
            --tg-text: #000;
            --tg-date: #8899a6;
            --tg-border: #dfe1e5;
            --tg-hover: #f4f4f5;
            --tg-selected: #3390ec;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--tg-bg); 
            margin: 0; height: 100vh; 
            display: flex; justify-content: center; align-items: center;
        }

        .app-container {
            width: 100%; height: 100%; max-width: 1400px;
            background: #fff; display: flex; overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        @media (min-width: 1000px) { .app-container { height: 95vh; } }

        /* –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø */
        .auth-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--tg-bg); display: none;
            justify-content: center; align-items: center; flex-direction: column; z-index: 100;
        }
        .auth-screen.active { display: flex; }
        .auth-box {
            background: white; padding: 40px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 320px; text-align: center;
        }
        .auth-box input {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 1px solid var(--tg-border); border-radius: 8px; box-sizing: border-box; outline: none;
        }
        .auth-box input:focus { border-color: var(--tg-blue); }
        .tg-btn {
            width: 100%; padding: 12px; margin-top: 10px; background: var(--tg-blue);
            color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        .tg-link { color: var(--tg-blue); cursor: pointer; margin-top: 15px; display: block; font-size: 14px; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        #main-interface { display: none; width: 100%; height: 100%; }
        #main-interface.active { display: flex; }

        /* SIDEBAR */
        .sidebar {
            width: 350px; border-right: 1px solid var(--tg-border);
            display: flex; flex-direction: column; background: white; position: relative;
        }
        .sidebar-header {
            padding: 10px 15px; display: flex; align-items: center; gap: 10px;
        }
        .chat-list { flex-grow: 1; overflow-y: auto; }
        
        .chat-item {
            padding: 10px 15px; display: flex; align-items: center; gap: 10px;
            cursor: pointer; border-bottom: 1px solid transparent; transition: 0.2s;
        }
        .chat-item:hover { background: var(--tg-hover); }
        .chat-item.active { background: var(--tg-selected); }
        .chat-item.active h4, .chat-item.active p, .chat-item.active .time { color: white !important; }
        
        .avatar {
            width: 50px; height: 50px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; color: white; font-size: 18px; flex-shrink: 0;
        }
        
        .chat-info { flex-grow: 1; min-width: 0; }
        .chat-top-row { display: flex; justify-content: space-between; align-items: baseline; }
        .chat-info h4 { margin: 0; font-size: 16px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-info .time { font-size: 12px; color: #888; }
        .chat-info p { 
            margin: 4px 0 0; font-size: 14px; color: #888; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .fab-add {
            position: absolute; bottom: 20px; right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--tg-blue); color: white; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 24px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; transition: transform 0.2s;
        }
        .fab-add:hover { transform: scale(1.1); }

        /* CHAT AREA */
        .chat-area {
            flex: 1; display: flex; flex-direction: column;
            background-color: var(--tg-chat-bg);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2387a6bd' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        .chat-header {
            padding: 10px 20px; background: white; border-bottom: 1px solid var(--tg-border);
            display: flex; justify-content: space-between; align-items: center; height: 40px;
        }
        .messages-container {
            flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px;
        }
        .message {
            max-width: 65%; padding: 6px 10px; border-radius: 8px;
            font-size: 15px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }
        .message.my { align-self: flex-end; background: var(--tg-my-msg); }
        .message.other { align-self: flex-start; background: var(--tg-white); }
        
        .msg-time {
            font-size: 11px; color: var(--tg-date); float: right; margin-left: 8px; margin-top: 5px;
        }

        .input-panel {
            background: white; padding: 10px 20px; display: flex; gap: 10px; align-items: center;
        }
        .input-panel input {
            flex-grow: 1; padding: 12px; border: none; background: #f4f4f5; border-radius: 20px; outline: none;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 200; display: none; justify-content: center; align-items: center;
        }
        .modal { background: white; width: 320px; padding: 20px; border-radius: 12px; position: relative; }
        .close-modal { position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 24px; color: #888; }
    </style>
</head>
<body>

<div class="app-container">

    <div id="login-screen" class="auth-screen active">
        <div class="auth-box">
            <h2 style="color:#3390ec;">Kotogram</h2>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="btn-login" class="tg-btn">–í–æ–π—Ç–∏</button>
            <div id="to-register" class="tg-link">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        </div>
    </div>

    <div id="register-screen" class="auth-screen">
        <div class="auth-box">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="text" id="reg-name" placeholder="–ò–º—è –∏ –§–∞–º–∏–ª–∏—è">
            <input type="date" id="reg-dob">
            <input type="email" id="reg-email" placeholder="Email">
            <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="btn-register" class="tg-btn">–ì–æ—Ç–æ–≤–æ</button>
            <div id="to-login" class="tg-link">–ù–∞–∑–∞–¥</div>
        </div>
    </div>

    <div id="main-interface">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <div style="font-weight: 700; font-size: 18px; color: #3390ec;">Kotogram</div>
                <div style="flex-grow:1;"></div>
                <div id="my-username" style="font-size: 14px; font-weight: bold; margin-right: 10px;"></div>
                <button id="btn-logout" style="border:none; background:none; cursor:pointer;">üö™</button>
            </div>

            <div class="chat-list" id="chat-list-container">
                </div>

            <button class="fab-add" id="btn-add-chat-fab">‚úèÔ∏è</button>
        </aside>

        <main class="chat-area">
            <div class="chat-header" id="chat-header" style="visibility: hidden;">
                <div class="header-info">
                    <h3 id="chat-user-name" style="margin:0; font-size:16px;">User</h3>
                    <span id="chat-user-email" style="font-size:13px; color:#888;">online</span>
                </div>
            </div>

            <div class="messages-container" id="messages-list">
                <div style="margin: auto; background: rgba(0,0,0,0.2); color: white; padding: 5px 15px; border-radius: 15px;">
                    –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π
                </div>
            </div>

            <div class="input-panel" id="input-panel" style="visibility: hidden;">
                <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button id="btn-send" style="background:none; border:none; color:var(--tg-blue); font-size:20px; cursor:pointer;">‚û§</button>
            </div>
        </main>
    </div>

</div>

<div class="modal-overlay" id="search-modal">
    <div class="modal">
        <span class="close-modal" id="close-modal">√ó</span>
        <h3>–ù–æ–≤—ã–π —á–∞—Ç</h3>
        <input type="email" id="search-email-input" placeholder="–í–≤–µ–¥–∏—Ç–µ email –¥—Ä—É–≥–∞">
        <div id="search-status" style="margin: 10px 0; font-size: 13px;"></div>
        <button id="btn-start-chat" class="tg-btn">–ù–∞–π—Ç–∏</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, query, orderByChild, equalTo, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBKp-HUZXSGSfBfEhl-HIjaC3Yflpqxg7s",
        authDomain: "kotogram-9b0b9.firebaseapp.com",
        databaseURL: "https://kotogram-9b0b9-default-rtdb.firebaseio.com",
        projectId: "kotogram-9b0b9",
        storageBucket: "kotogram-9b0b9.firebasestorage.app",
        messagingSenderId: "755607509917",
        appId: "1:755607509917:web:29b1b85eea516bde702d74"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let currentChatId = null; 
    let activeChatPartnerId = null;
    let activeChatPartnerName = "";

    const screens = {
        login: document.getElementById('login-screen'),
        register: document.getElementById('register-screen'),
        main: document.getElementById('main-interface')
    };

    // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
    document.getElementById('to-register').onclick = () => { screens.login.classList.remove('active'); screens.register.classList.add('active'); };
    document.getElementById('to-login').onclick = () => { screens.register.classList.remove('active'); screens.login.classList.add('active'); };
    document.getElementById('btn-add-chat-fab').onclick = () => { 
        document.getElementById('search-modal').style.display = 'flex'; 
        document.getElementById('search-status').innerText = ''; 
    };
    document.getElementById('close-modal').onclick = () => document.getElementById('search-modal').style.display = 'none';

    // --- AUTH ---
    document.getElementById('btn-register').onclick = async () => {
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-password').value;
        const name = document.getElementById('reg-name').value;
        if(!email || !pass || !name) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");
        try {
            const cred = await createUserWithEmailAndPassword(auth, email, pass);
            await set(ref(db, 'users/' + cred.user.uid), { username: name, email, uid: cred.user.uid });
        } catch(e) { alert(e.message); }
    };

    document.getElementById('btn-login').onclick = async () => {
        try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); }
        catch(e) { alert("–û—à–∏–±–∫–∞: " + e.message); }
    };
    document.getElementById('btn-logout').onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            screens.login.classList.remove('active');
            screens.register.classList.remove('active');
            screens.main.classList.add('active');
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–≤–æ—ë –∏–º—è –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            get(ref(db, 'users/' + user.uid)).then(s => {
                if(s.exists()) document.getElementById('my-username').innerText = s.val().username;
            });

            loadUserChats(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        } else {
            currentUser = null;
            screens.main.classList.remove('active');
            screens.login.classList.add('active');
            document.getElementById('chat-list-container').innerHTML = '';
        }
    });

    // --- –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –ß–ê–¢–û–í (SIDEBAR) ---
    function loadUserChats() {
        const userChatsRef = ref(db, 'user-chats/' + currentUser.uid);
        
        onValue(userChatsRef, (snapshot) => {
            const list = document.getElementById('chat-list-container');
            list.innerHTML = '';
            const chats = [];
            
            snapshot.forEach(child => {
                chats.push(child.val());
            });

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            chats.sort((a, b) => b.lastMsgTime - a.lastMsgTime);

            if (chats.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:20px; color:#999;">–ù–µ—Ç —á–∞—Ç–æ–≤</div>`;
                return;
            }

            chats.forEach(chat => {
                const div = document.createElement('div');
                div.className = `chat-item ${activeChatPartnerId === chat.partnerId ? 'active' : ''}`;
                div.onclick = () => openChat(chat.partnerId, chat.partnerName, chat.partnerEmail);

                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ü–≤–µ—Ç–∞ –∞–≤–∞—Ç–∞—Ä–∞
                const colors = ['#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#00bcd4', '#009688', '#4caf50'];
                const color = colors[chat.partnerName.length % colors.length];
                const initials = chat.partnerName.substring(0,2).toUpperCase();
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
                const date = new Date(chat.lastMsgTime);
                const timeStr = date.getHours().toString().padStart(2,'0') + ':' + date.getMinutes().toString().padStart(2,'0');

                const prefix = chat.lastMsgSender === currentUser.uid ? '<span style="color:var(--tg-blue)">–í—ã:</span> ' : '';

                div.innerHTML = `
                    <div class="avatar" style="background: ${color}">${initials}</div>
                    <div class="chat-info">
                        <div class="chat-top-row">
                            <h4>${chat.partnerName}</h4>
                            <span class="time">${timeStr}</span>
                        </div>
                        <p>${prefix}${chat.lastMsg}</p>
                    </div>
                `;
                list.appendChild(div);
            });
        });
    }

    // --- –ü–û–ò–°–ö –ò –°–¢–ê–†–¢ –ß–ê–¢–ê ---
    document.getElementById('btn-start-chat').onclick = async () => {
        const email = document.getElementById('search-email-input').value;
        if(email === currentUser.email) return;

        const q = query(ref(db, 'users'), orderByChild('email'), equalTo(email));
        const snap = await get(q);

        if(snap.exists()) {
            const data = snap.val();
            const uid = Object.keys(data)[0];
            const info = data[uid];
            
            document.getElementById('search-modal').style.display = 'none';
            openChat(uid, info.username, info.email);
        } else {
            document.getElementById('search-status').innerText = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω";
            document.getElementById('search-status').style.color = "red";
        }
    };

    function openChat(partnerId, name, email) {
        activeChatPartnerId = partnerId;
        activeChatPartnerName = name;
        
        // UI
        document.getElementById('chat-header').style.visibility = 'visible';
        document.getElementById('input-panel').style.visibility = 'visible';
        document.getElementById('chat-user-name').innerText = name;
        document.getElementById('chat-user-email').innerText = email;

        // –í—ã–¥–µ–ª–µ–Ω–∏–µ –≤ –º–µ–Ω—é (–ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –∫–ª–∞—Å—Å–æ–≤)
        const items = document.querySelectorAll('.chat-item');
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π (–Ω–µ–º–Ω–æ–≥–æ –∫–æ—Å—Ç—ã–ª—å, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)
        // loadUserChats() —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, —Ç–∞–∫ —á—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å—Ç–∏–ª—å –æ–±–Ω–æ–≤–∏–º
        
        // Chat ID
        const ids = [currentUser.uid, partnerId].sort();
        currentChatId = ids[0] + "_" + ids[1];

        loadMessages();
    }

    function loadMessages() {
        const list = document.getElementById('messages-list');
        list.innerHTML = '';
        
        onValue(ref(db, 'messages/' + currentChatId), (snap) => {
            list.innerHTML = '';
            const data = snap.val();
            if(data) {
                Object.values(data).forEach(msg => {
                    const isMy = msg.senderId === currentUser.uid;
                    const el = document.createElement('div');
                    el.className = `message ${isMy ? 'my' : 'other'}`;
                    const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    el.innerHTML = `${msg.text}<span class="msg-time">${time}</span>`;
                    list.appendChild(el);
                });
                list.scrollTop = list.scrollHeight;
            }
        });
    }

    // --- –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø (–û–ë–ù–û–í–õ–Ø–ï–ú –î–õ–Ø –î–í–£–• –°–¢–û–†–û–ù) ---
    document.getElementById('btn-send').onclick = sendMessage;
    document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

    async function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if(!text || !currentChatId) return;

        const timestamp = Date.now();

        // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∞–º–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
        push(ref(db, 'messages/' + currentChatId), {
            senderId: currentUser.uid,
            text: text,
            timestamp: timestamp
        });

        // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –¥–ª—è –ú–ï–ù–Ø (—á—Ç–æ–±—ã –±—ã–ª —Å–≤–µ—Ä—Ö—É)
        await update(ref(db, 'user-chats/' + currentUser.uid + '/' + activeChatPartnerId), {
            partnerId: activeChatPartnerId,
            partnerName: activeChatPartnerName, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –¥—Ä—É–≥–∞, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –ø–æ–∫–∞–∑–∞—Ç—å
            partnerEmail: document.getElementById('chat-user-email').innerText,
            lastMsg: text,
            lastMsgTime: timestamp,
            lastMsgSender: currentUser.uid
        });

        // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –¥–ª—è –î–†–£–ì–ê (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ!)
        // –ù–∞–º –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –º–æ—ë –∏–º—è, —á—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å –µ–≥–æ –¥—Ä—É–≥—É
        const myName = document.getElementById('my-username').innerText || currentUser.email;
        
        await update(ref(db, 'user-chats/' + activeChatPartnerId + '/' + currentUser.uid), {
            partnerId: currentUser.uid,
            partnerName: myName,
            partnerEmail: currentUser.email,
            lastMsg: text,
            lastMsgTime: timestamp,
            lastMsgSender: currentUser.uid
        });

        input.value = '';
    }
</script>

</body>
</html>
